@{
    ViewBag.Title = "Register";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<section class="content">
    <div class="container">
        <div class="card" style="background-color:white">
            <div class="card-header card-header-info" style="background-color:#006699">
                <h4 class="card-title font-weight-bolder" style="color:#FF6600; text-shadow: 0 0 3px #FF0000">Register</h4>
                <p class="card-text font-weight-bolder" style="color:#F4CC70; text-shadow: 0 0 3px #FF0000">TesKey / Surat</p>
            </div>
            <div class="card-body">
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <input type="hidden" id="regisId" />
                            <label class="bmd-label-floating">Tipe Surat</label>
                            <br />
                            <select required id="tipe" name="tipe" data-placement="choose" class="form-control select2 select2 select2-hidden-accessible" style="width:100%" tabindex="-1" aria-hidden="true">
                                <option value="">--- Pilih Tipe Surat ---</option>
                            </select>
                            <br />
                            <label class="control-label">Nomor Referensi</label>
                            <input id="NoReferensi" type="text" class="form-control" />
                            <label class="control-label">Nomor Referensi</label>
                            <input id="NoReferensi" type="text" class="form-control" />
                            <label class="bmd-label-floating">Tanggal Surat</label>
                            <input id="TanggalSurat" type="date" class="form-control " />
                            <label class="bmd-label-floating">Nomor Surat / Memo</label>
                            <input id="NomorSurat" type="text" class="form-control " />
                            <label class="control-label">Nama Penerima</label>
                            <input id="Nama" type="text" class="form-control" />
                            <label class="control-label ">Nominal</label>
                            <input id="Nominal" type="text" class="form-control number" />

                            <label class="control-label">Bank</label>
                            <select required Id="BTujuan" name="banktj" data-placement="choose" class="form-control select2 select2-hidden-accessible" style="width:100%" tabindex="-1" aria-hidden="true">
                                <option value="">--Pilih Bank--</option>
                            </select>
                            <br />
                            <label class="control-label">Alasan</label>
                            <br />
                            <select required Id="Alasan" name="Alasan" onchange="AddAlasan();" data-placement="choose" class="form-control select2 select2-hidden-accessible" style="width:100%" tabindex="-1" aria-hidden="true"></select>
                            <div id="Alasan-div">
                                <label class="control-label">Alasan Lain</label>
                                <br />
                                <input id="alasanLain" class="form-control" type="text" />
                            </div>
                        </div>
                        <div class="col">
                            <label class="bmd-label-floating">Tanggal Transaksi</label>
                            <input id="TanggalTRX" type="date" class="form-control " />
                            <label class="bmd-label-floating" style="padding-top:6px">Pilih Tujuan</label>
                            <br />
                            <label class="radio-inline"><input type="radio" name="optradio" id="radDivisi" value="1"> Divisi</label>
                            <label class="radio-inline"><input type="radio" name="optradio" id="radCabang" value="2"> Cabang</label>
                            <br />
                            <div id="div-cab">
                                <label class="bmd-label-floating">Cabang</label>
                                <select id="Cabang" name="cabang" onchange="AddCabang();" data-placement="choose" class="form-control select2 select2-hidden-accessible" style="width:100%" tabindex="-1" aria-hidden="true"></select>
                                <div id="cabang-div">
                                    <label class="control-label">Nama Cabang</label>
                                    <br />
                                    <input id="cabanglain" class="form-control" type="text" />
                                    <label class="control-label">Kode Cabang</label>
                                    <br />
                                    <input id="kodecabang" class="form-control" type="text" style="text-transform: uppercase" />
                                    <label class="control-label">Sandi Cabang</label>
                                    <br />
                                    <input id="sandi" class="form-control" type="text" />
                                </div>
                            </div>
                            <div id="div-div">
                                <label class="bmd-label-floating">Divisi</label>
                                <br />
                                <select id="Divisi" name="divisi" onchange="AddDivisi();" data-placement="choose" class="form-control select2 select2-hidden-accessible" style="width:100%" tabindex="-1" aria-hidden="true"></select>
                                <div id="divisi-div">
                                    <label class="control-label">Nama Divisi</label>
                                    <br />
                                    <input id="cabanglain" class="form-control" type="text" />

                                    <label class="control-label">Kode Divisi</label>
                                    <br />
                                    <input id="kodecabang" class="form-control" type="text" style="text-transform: uppercase" />
                                    <label class="control-label">Sandi Divisi</label>
                                    <br />
                                    <input id="sandi" class="form-control" type="text" />
                                </div>
                            </div>
                            <label class="bmd-label-floating">Tanggal TestKey</label>
                            <input id="TanggalTK" type="date" class="form-control " />
                            <label class="control-label">Nomor Teskey</label>
                            <input id="NoTeskey" type="text" class="form-control" />
                            <label class="control-label">Nomor Rekening</label>
                            <input id="NomorRekening" type="text" class="form-control" />
                            <label class="control-label ">Nominal Seharusnya</label>
                            <input id="Nominal2" type="text" class="form-control number" />
                            <div class="col-md-4 mt-5">
                                <label class="control-label">Lampiran Bukti</label>
                                <br />
                                <input type="hidden" id="Path" />
                                <input type="file" class="inputFileHidden" id="path" accept=".pdf" style="min-width:100%">
                                @*<canvas style="border:1px solid grey;" id="Path"></canvas>*@
                            </div>
                        </div>
                    </div>
                    <div class="row mt-5">
                        <div class="col d-flex justify-content-end">
                            <a class="btn btn-primary text-white" id="Save">Save</a>
                            <a class="btn btn-light text-black" href="@Url.Action("Index","Home")" style="margin-left:10px;">Back</a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>

@section scripts{
    <script>
        $(document).ready(function () {
            //GetTypes();
            //GetBank();
            GetDivisi();
            GetAlasan();
            GetCabang();
            GetType();
            GetBank();
            $("#Alasan-div").hide();
            $("#cabang-div").hide();
            $("#divisi-div").hide();
            $("#div-div").hide();
            $("#div-cab").hide();
            $(".select2").select2({
                "theme": "classic"
            });
            debugger;
            $('#path').on('change', function (e) {
                
                const files = e.target.files;
                if (files.length > 0) {
                    const file = files[0];
                    $(this).next().text(file.name)
                } else {
                    $(this).next().text("Choose File")
                }
            })
        });

        function GetType() {
            $.ajax({
                url: "@Url.Action("GetType","Kliring")",
                type: "Get",
                dataType: "json",
                success: function ({ data }) {
                    //console.log(data);
                    $("select[name=tipe]").empty();
                    $("select[name=tipe]").append('<option value="">-- Pilih Tipe Surat --</option>')
                    $.each(data, function (i, value) {
                        $("select[name=tipe]").append(`<option value="${value.id}">${value.nama}</option>`)
                    })
                }
            })
        }

        function GetBank() {
            $.ajax({
                url: "@Url.Action("GetBank","Master")",
                type: "Get",
                dataType: "json",
                success: function ({ data }) {
                    console.log(data);
                    $("select[name=banktj]").empty();
                    $("select[name=banktj]").append('<option value="">--Pilih Bank--</option>')
                    $.each(data, function (i, value) {
                        $("select[name=banktj]").append(`<option value="${value.id}">${value.nama}</option>`)
                    })
                }
            })
        }

        function GetCabang() {
            $.ajax({
                url: "@Url.Action("GetCabang","Master")",
                type: "Get",
                dataType: "json",
                success: function ({ data }) {

                    $("select[name= cabang]").empty();
                    $("select[name=cabang]").append('<option value="">--Pilih Cabang--</option>')
                    $("select[name=cabang]").append('<option value="custom" style="font-weight:bold"><strong>TAMBAH CABANG</strong></option>')
                    $.each(data, function (i, value) {
                        $("select[name=cabang]").append(`<option value="${value.id}">${value.nama}</option>`)
                    })
                }
            })
        }

        function GetDivisi() {
            $.ajax({
                url: "@Url.Action("GetDivisi","Master")",
                type: "Get",
                dataType: "json",
                success: function ({ data }) {
                    debugger;
                    console.log(data);
                    $("select[name=divisi]").empty();
                    $("select[name=divisi]").append('<option value="">--Pilih Divisi--</option>')
                    $("select[name=divisi]").append('<option value="custom" style="font-weight:bold"><strong>TAMBAH DIVISI</strong></option>')
                    $.each(data, function (i, value) {
                        $("select[name=divisi]").append(`<option value="${value.id}">${value.nama}</option>`)
                    })
                }
            });
        }


        $("input[name=optradio]").change(() => {
            if ($("#radCabang").is(":checked")) {
                $('#div-cab').show();
                $('#div-div').hide();
            } else {
                $('#div-div').show();
                $('#div-cab').hide();

            }
        });

        function GetAlasan() {
            $.ajax({
                "url": "@Url.Action("GetAlasan","Master")",
                "type": "Get",
                "datatype": "json"
            }).then(({ data }) => {
                //console.log(data)
                var alasan = $("#Alasan");
                alasan.html('');
                $("<option></option>").val('').text('--- Pilih Alasan ---').appendTo(alasan);
                $("<option></option>").val('custom').text(' *Alasan Lain* ').appendTo(alasan);
                $.each(data, function (i, value) {
                    $("<option></option>").val(value.id).text(value.nama).appendTo(alasan);
                });
            });
        }


        function AddAlasan() {
            var Alasan = $("#Alasan").val();
            if (Alasan == 'custom') {
                $("#Alasan-div").show();
            }
            else {
                $("#Alasan-div").hide();
            }
        }

        function AddCabang() {
            var Cabang = $("#Cabang").val();
            if (Cabang == 'custom') {
                $("#cabang-div").show();
            }
            else {
                $("#cabang-div").hide();
            }
        }

        function AddDivisi() {
            var Divisi = $("#Divisi").val();
            if (Divisi == 'custom') {
                $("#divisi-div").show();
            }
            else {
                $("#divisi-div").hide();
            }
        }

        function FileToBase(file) {
            debugger;
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                fileReader.onloadend = function (result) {
                    resolve(result.target.result);
                }
                fileReader.onerror = function (err) {
                    reject(err)
                }
                fileReader.readAsDataURL(file);
            });
        }

        //Input number only with thousand separator

        $('#Save').click(async function () {
            debugger;
            const files = $("#path").prop('files');
            //debugger;
            const b64 = await FileToBase(files[0]);
            const path = {
                base64: b64,
                fileName: files[0].name
            }

            var isAllValid = true;
            //validate order items
            $('#ItemError').text('');
            var canvas = document.getElementById('Path');
            //var dataURL = canvas.toDataURL();
            var errorItemCount = 0;
            //debugger;
            if (errorItemCount > 0) {
                $('#ItemError').text(errorItemCount + " invalid entry in order item list.");
                isAllValid = false;
            }

            if ($('#NomorSurat').val().trim() == '' && $('#tipe').val() == 2) {
                $('#NomorSurat').addClass('is-invalid');
                isAllValid = false;
            }
            else {
                $('#NomorSurat').removeClass('is-invalid');
            }

            if ($('#TanggalSurat').val() == '') {
                $("#TanggalSurat").addClass('is-invalid');
                isAllValid = false;
            }
            else {
                $("#TanggalSurat").removeClass('is-invalid');
            }

            if ($('#tipe').val() == '') {
                $("#tipe").addClass('is-invalid');
                isAllValid = false;
            }
            else {
                $('#tipe').removeClass('is-invalid');
            }
            if ($('#Nama').val() == '') {
                $('#Nama').addClass('is-invalid');
                isAllValid = false;
            }
            else {
                $('#Nama').removeClass('is-invalid');
            }
            if ($('#NomorRekening').val() == '') {
                $('#NomorRekening').addClass('is-invalid');
                isAllValid = false;
            }
            else {
                $('#NomorRekening').removeClass('is-invalid');
            }
            if ($('#Nominal').val() == '') {
                $('#Nominal').addClass('is-invalid');
                isAllValid = false;
            }
            else {
                $('#Nominal').siblings('span.error').css('visibility', 'hidden');
            }

            if ($('#BPengirim').val() == '') {
                $('#BPengirim').addClass('is-invalid');
                isAllValid = false;
            }
            else {
                $('#BPengirim').siblings('span.error').css('visibility', 'hidden');
            }

            if ($('#BTujuan').val() == '') {
                $('#BTujuan').siblings('span.error').css('visibility', 'visible');
                isAllValid = false;
            }
            else {
                $('#BTujuan').siblings('span.error').css('visibility', 'hidden');
            }

            if ($('#Alasan').val() == '') {
                $('#Alasan').siblings('span.error').css('visibility', 'visible');
                $('.Alasan').addClass('has-error');
                isAllValid = false;
            }
            else {
                $('#Alasan').siblings('span.error').css('visibility', 'hidden');
            }
            $("input[name=optradio]").change(() => {
                if ($("#radCabang").is(":checked")) {
                    if ($('#Cabang').val() == '') {
                        $('#Cabang').siblings('span.error').css('visibility', 'visible');
                        $('.Cabang').addClass('has-error');
                        isAllValid = false;
                    }
                    else {
                        $('#Cabang').siblings('span.error').css('visibility', 'hidden');
                    }
                } else {
                    if ($('#Divisi').val() == '') {
                        $('#Divisi').siblings('span.error').css('visibility', 'visible');
                        $('.Divisi').addClass('has-error');
                        isAllValid = false;
                    }
                    else {
                        $('#Divisi').siblings('span.error').css('visibility', 'hidden');
                    }
                }
            });
            if ($('#NoTeskey').val() == '') {
                $('#NoTeskey').siblings('span.error').css('visibility', 'visible');
                $('.NoTeskey').addClass('has-error');
                isAllValid = false;
            }
            else {
                $('#NoTeskey').siblings('span.error').css('visibility', 'hidden');
            }
            if ($('#TanggalTRX').val() == '') {
                $('#TanggalTRX').siblings('span.error').css('visibility', 'visible');
                $('.TanggalTRX').addClass('has-error');
                isAllValid = false;
            }
            else {
                $('#TanggalTRX').siblings('span.error').css('visibility', 'hidden');
            }
            if ($('#NoReferensi').val() == '') {
                $('#NoReferensi').siblings('span.error').css('visibility', 'visible');
                $('.NoReferensi').addClass('has-error');
                isAllValid = false;
            }
            else {
                $('#NoReferensi').siblings('span.error').css('visibility', 'hidden');
            }

            if (isAllValid) {
                debugger;
                var data = new Object();

                if ($("#radCabang").val() == 2) {
                    data.CabangId = $("#Cabang").val();
                    data.CabangLain = $("cabanglain").val();
                    data.KodeCabang = $("kodecabang").val();
                    data.Type_Dept = 2;
                } else {
                    data.CabangId = $("#Divisi").val();
                    data.CabangLain = $("divisilain").val();
                    data.KodeCabang = $("kodedivisi").val();
                    data.Type_Dept = 1;
                }

                data.NomorSurat = $("#NomorSurat").val();
                data.TanggalSurat = $("#TanggalSurat").val();
                data.TypeId = $("#tipe").val();
                data.NamaPenerima = $("#Nama").val();
                data.NomorRekening = $("#NomorRekening").val();
                data.Nominal = minkoma($("#Nominal").val());
                data.BankId = $("#BTujuan").val();
                data.AlasanId = $("#Alasan").val();
                data.AlasanLain = $("#alasanLain").val();
                data.Path = path;
                data.TanggalTRX = $("#TanggalTRX").val();
                data.TanggalTestKey = $("#TanggalTK").val();
                data.NomorTestKey = $("#NoTeskey").val();
                data.NoReferensi = $("#NoReferensi").val();
                //data.CabangId = $("#Cabang").val();
                data.NominalSeharusnya = minkoma($("#Nominal2").val());
                console.log(data);

                $.ajax({
                    url: '@Url.Action("Save","Kliring")',
                    type: 'Post',
                    dataType: "json",
                    data: data,

                    success: function (response) {
                        Swal.fire({
                            icon: "success",
                            title: "Berhasil",
                            text: "Data Berhasil Di Tambah"
                        }).then(function () {
                            location.href = '@Url.Action("Proses","Kliring")';
                        });

                    }, error: (err) => {
                        Swal.fire({
                            icon: "error",
                            title: "Gagal",
                            text: "Data Gagal Di Tambah"
                        }).then(function () {
                            location.reload();
                        });
                    }
                });

            }

            $(this).val('Please wait...');

        })

        $(document).on("keyup", ".number", (function (event) {

            // skip for arrow keys
            if (event.which >= 37 && event.which <= 40) return;

            // format number
            $(this).val(function (index, value) {
                return value
                    .replace(/\D/g, "")
                    .replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                    ;
            });
        }));

        $(document).on("keyup", ".miring", (function (event) {

            // skip for arrow keys
            if (event.which >= 34 && event.which <= 40) return;

            // format number
            $(this).val(function (index, value) {
                return value
                    .replace(/\D/g, "")
                    .replace(/\B(?=(\d{3})+(?!\d))/g, "/")
                    ;
            });
        }));

        function minkoma(angka) {
            var bil = angka;
            var loop = Math.floor(angka.length / 3);
            for (var i = 0; i < loop; i++) {
                bil = bil.replace(',', '');
            }
            return bil;
        }


        $(function () {
            $('.datepicker').datepicker(
                {
                    dateFormat: "mm/dd/yy",
                    changeMonth: true,
                    changeYear: true,
                    showButtonPanel: true,
                    onClose: function (dateText, inst) {


                        function isDonePressed() {
                            return ($('#ui-datepicker-div').html().indexOf('ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all ui-state-hover') > -1);
                        }

                        if (isDonePressed()) {
                            var month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
                            var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
                            $(this).datepicker('setDate', new Date(year, month, 1)).trigger('change');

                            $('.date-picker').focusout()//Added to remove focus from datepicker input box on selecting date
                        }
                    },
                    beforeShow: function (input, inst) {

                        inst.dpDiv.addClass('month_year_datepicker')

                        if ((datestr = $(this).val()).length > 0) {
                            year = datestr.substring(datestr.length - 4, datestr.length);
                            month = datestr.substring(0, 2);
                            $(this).datepicker('option', 'defaultDate', new Date(year, month - 1, 1));
                            $(this).datepicker('setDate', new Date(year, month - 1, 1));
                            $(".ui-datepicker-calendar").hide();
                        }
                    }
                })
        });
    </script>
} 